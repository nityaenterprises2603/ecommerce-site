<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nitya Online Fashion – Inventory (JSONBin)</title>
  <style>
    :root { --gap: 12px; }
    body{font-family: system-ui, Arial, sans-serif; margin:0; background:#fafafa; color:#111}
    header{display:flex; gap:12px; align-items:center; padding:14px 18px; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.06); position:sticky; top:0; z-index:2}
    header img{height:48px; width:auto;}
    header h1{font-size:20px; margin:0}
    main{padding:18px; max-width:1100px; margin:0 auto}
    .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:var(--gap)}
    .card{background:#fff; border-radius:12px; padding:14px; box-shadow:0 4px 16px rgba(0,0,0,.06); display:flex; flex-direction:column}
    .card h3{margin:6px 0 8px}
    .price{font-weight:600; margin-top:auto}
    .stock{font-size:12px; color:#444}
    .actions{display:flex; gap:8px; margin-top:10px}
    button{padding:8px 10px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer}
    button.primary{background:#111; color:#fff; border-color:#111}
    button:disabled{opacity:.45; cursor:not-allowed}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .cart{position:sticky; bottom:0; background:#111; color:#fff; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; border-top-left-radius:12px; border-top-right-radius:12px}
    .cart small{opacity:.85}
    .badge{background:#fff; color:#111; border-radius:999px; padding:2px 8px; font-weight:700; margin-left:6px}
    .muted{opacity:.7}
    .toast{position:fixed; right:12px; bottom:82px; background:#111; color:#fff; padding:10px 12px; border-radius:10px; opacity:0; transform:translateY(6px); transition:.2s}
    .toast.show{opacity:1; transform:translateY(0)}
    .footer{margin-top:20px; font-size:12px; color:#444}
  </style>
</head>
<body>
<header>
  <!-- Replace with your real logo source -->
  <img src="Images/logo.png" alt="Nitya Logo" />
  <h1>Nitya Online Fashion</h1>
</header>

<main>
  <div class="row">
    <div>
      <strong>Inventory source:</strong>
      <span class="muted">JSONBin (reads via your server, writes via secure patch)</span>
    </div>
    <div id="invStatus" class="muted">Loading inventory…</div>
  </div>

  <h2>Imitation Jewellery</h2>
  <div id="products" class="grid"></div>

  <div class="footer">
    Tip: Stock is locked at checkout (server-side). Buttons disable when stock is 0.
  </div>
</main>

<div class="cart">
  <div>
    <strong>Cart</strong>
    <span class="badge" id="cartCount">0</span>
    <small id="cartValue" class="muted">₹0</small>
  </div>
  <div class="row">
    <button id="clearBtn">Clear</button>
    <button id="checkoutBtn" class="primary">Checkout</button>
  </div>
</div>

<div id="toast" class="toast">Saved</div>

<script>
/********************
  CONFIG
********************/
// Point this to your deployed server from my previous message (Express/Workers/etc.)
const API_BASE = "http://localhost:8080"; // e.g. https://inventory.nitya.in

/********************
  CATALOG (example)
********************/
const catalog = [
  { id: "NEC-650-01", name: "Oxidized Necklace – NEC-650-01", price: 599 },
  { id: "RING-12", name: "Ring Size 12", price: 299 },
  { id: "BANGLE-2.2", name: "Bangle 2.2", price: 349 },
  { id: "MANGALSUTRA-FS", name: "Mangalsutra (Free Size)", price: 449 }
];

/********************
  STATE
********************/
let inventory = {}; // { sku: qty }
let cart = {};      // { sku: qty }

/********************
  HELPERS
********************/
const fmt = n => `₹${Number(n).toLocaleString('en-IN')}`;
function toast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 1400);
}

function renderProducts(){
  const wrap = document.getElementById('products');
  wrap.innerHTML = '';
  catalog.forEach(p => {
    const stock = Number(inventory[p.id] ?? 0);
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h3>${p.name}</h3>
      <div class="price">${fmt(p.price)}</div>
      <div class="stock">Stock: <strong>${stock}</strong></div>
      <div class="actions">
        <button data-sku="${p.id}" class="add" ${stock<=0?'disabled':''}>Add</button>
        <button data-sku="${p.id}" class="remove" ${!cart[p.id]?'disabled':''}>Remove</button>
      </div>
    `;
    wrap.appendChild(card);
  });

  // wire buttons
  wrap.querySelectorAll('button.add').forEach(btn => btn.addEventListener('click', () => addToCart(btn.dataset.sku)));
  wrap.querySelectorAll('button.remove').forEach(btn => btn.addEventListener('click', () => removeFromCart(btn.dataset.sku)));
}

function redrawCart(){
  const count = Object.values(cart).reduce((a,b)=>a+b,0);
  const value = Object.entries(cart).reduce((sum, [sku, qty]) => {
    const p = catalog.find(x=>x.id===sku); return sum + (p? p.price*qty : 0);
  }, 0);
  document.getElementById('cartCount').textContent = count;
  document.getElementById('cartValue').textContent = fmt(value);

  // Rebuild product cards to update Remove button disabled state
  renderProducts();
}

function addToCart(sku){
  const stock = Number(inventory[sku]||0);
  const inCart = Number(cart[sku]||0);
  if(inCart >= stock){ toast('Not enough stock'); return; }
  cart[sku] = inCart + 1;
  redrawCart();
}

function removeFromCart(sku){
  const inCart = Number(cart[sku]||0);
  if(inCart>0){ cart[sku] = inCart - 1; if(cart[sku]===0) delete cart[sku]; }
  redrawCart();
}

/********************
  SERVER I/O
********************/
async function loadInventory(){
  try{
    document.getElementById('invStatus').textContent = 'Loading inventory…';
    const r = await fetch(`${API_BASE}/inventory`);
    if(!r.ok) throw new Error(await r.text());
    inventory = await r.json();
    document.getElementById('invStatus').textContent = 'Inventory synced';
  }catch(err){
    console.error(err);
    document.getElementById('invStatus').textContent = 'Failed to load inventory';
  }
  renderProducts();
}

// Create patch deltas from cart: decrements stock by ordered qty
function buildPatch(){
  const patch = {};
  for(const [sku, qty] of Object.entries(cart)){
    if(qty>0) patch[sku] = -qty;
  }
  return patch;
}

async function checkout(){
  if(Object.keys(cart).length===0){ toast('Cart is empty'); return; }
  try{
    document.getElementById('checkoutBtn').disabled = true;
    const patch = buildPatch();
    const r = await fetch(`${API_BASE}/inventory/patch`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(patch)
    });
    if(!r.ok) throw new Error(await r.text());
    const data = await r.json();
    // server returns updated inventory
    inventory = data.inventory || inventory;
    cart = {};
    redrawCart();
    toast('Order placed & stock updated');
  }catch(err){
    console.error(err);
    toast('Checkout failed');
  }finally{
    document.getElementById('checkoutBtn').disabled = false;
  }
}

/********************
  INIT
********************/
window.addEventListener('DOMContentLoaded', async () => {
  renderProducts();
  await loadInventory();
  document.getElementById('checkoutBtn').addEventListener('click', checkout);
  document.getElementById('clearBtn').addEventListener('click', ()=>{ cart={}; redrawCart(); });
});
</script>
</body>
</html>
