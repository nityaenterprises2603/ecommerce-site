<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nitya Enterprises ‚Äî E‚ÄëCommerce (Cloud‚ÄëSynced Inventory)</title>
  <meta name="description" content="Oxidized Jewellery & Traditional Clothing ‚Äî Cloud‚Äësynced per‚Äësize inventory with JSONBin, bucket cart, UPI checkout, Email & WhatsApp order."/>
  <style>
    :root{
      --maroon:#6A0D25; --orange:#FF6600; --bg:#fff8f3; --ink:#222; --muted:#666; --card:#ffffff; --ring: rgba(0,0,0,.08);
      --oos:#b91c1c; --ok:#1b5e20; --warn:#eab308; --good:#16a34a; --bad:#dc2626; --info:#2563eb;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    a{color:inherit}
    header{position:sticky;top:0;z-index:60;background:var(--maroon);color:#fff;border-bottom:3px solid var(--orange)}
    .wrap{max-width:1100px;margin:auto;padding:0 16px}
    .nav{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
    .brand{display:flex;gap:10px;align-items:center}
    .brand .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--orange),#ffa366);display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
    .brand h1{font-size:1.05rem;margin:0;letter-spacing:.3px}
    .menu{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .menu a{padding:8px 10px;border-radius:8px;color:#fff;text-decoration:none}
    .menu a:hover{background:rgba(255,255,255,.12)}
    .bucket-btn{display:inline-flex;gap:8px;align-items:center;background:var(--orange);color:#fff;padding:8px 12px;border-radius:999px;border:none;font-weight:700;cursor:pointer}
    .count{background:#fff;color:var(--orange);font-weight:800;border-radius:999px;padding:2px 8px}
    .admin-link{border:1px solid rgba(255,255,255,.5); padding:6px 10px; border-radius:999px; cursor:pointer; font-weight:700}

    .hero{background:linear-gradient(180deg,rgba(106,13,37,.10),rgba(255,102,0,.08));padding:28px 0}
    .hero h2{margin:6px 0;font-size:1.6rem}
    .hero p{color:#2d2d2d;margin:6px 0 2px}
    .tag{display:inline-block;background:#fff;border:1px solid var(--ring);padding:6px 10px;border-radius:999px;margin-top:8px}

    .section{padding:28px 0}
    .section h3{margin:0 0 14px;font-size:1.25rem;color:var(--maroon)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:20px}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:14px;overflow:hidden;box-shadow:0 3px 10px rgba(0,0,0,.06);transition:.2s ease}
    .card:hover{transform:translateY(-2px)}
    .thumb{width:100%;height:280px;object-fit:cover;background:#f1f1f1;display:block}
    .pad{padding:12px}
    .title{font-weight:700;margin:0 0 4px}
    .price{color:var(--muted);font-size:.95rem}

    .sizes{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .size-btn{border:1px solid var(--ring);background:#fff;padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:600;position:relative}
    .size-btn[aria-pressed="true"]{background:var(--maroon);color:#fff;border-color:var(--maroon)}
    .size-btn[disabled]{opacity:.45;text-decoration:line-through;border-style:dashed;cursor:not-allowed}
    .size-btn .stock-dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-left:6px;vertical-align:middle;background:var(--ok)}
    .size-btn[disabled] .stock-dot{background:var(--oos)}
    .size-hint{font-size:.85rem;color:var(--muted);margin-top:4px}

    .btns{display:flex;gap:8px;margin-top:12px}
    .btn{flex:1;display:inline-flex;align-items:center;justify-content:center;gap:8px;border-radius:10px;padding:8px 10px;border:1px solid var(--ring);background:#fff;cursor:pointer}
    .btn.add{background:var(--orange);border-color:var(--orange);color:#fff;font-weight:700}
    .btn.remove{color:var(--maroon);font-weight:700}
    .btn.bucket{background:var(--maroon);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .drawer{position:fixed;right:0;top:0;height:100dvh;width:min(420px,95vw);background:#fff;border-left:3px solid var(--orange);box-shadow:-8px 0 20px rgba(0,0,0,.12);transform:translateX(105%);transition:.28s ease;z-index:65;display:flex;flex-direction:column}
    .drawer.open{transform:translateX(0)}
    .drawer header{background:#fff;color:#111;border-bottom:1px solid var(--ring)}
    .drawer h4{margin:0;font-size:1.1rem}
    .drawer .body{padding:12px;overflow:auto;flex:1}
    .cart-item{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center;border-bottom:1px dashed var(--ring);padding:10px 0}
    .cart-item img{width:56px;height:42px;object-fit:cover;border-radius:6px}
    .small{color:var(--muted);font-size:.9rem}
    .row{display:flex;justify-content:space-between;gap:10px;margin:6px 0}
    .total{font-weight:800;font-size:1.05rem}

    .order{background:#fff;border:1px solid var(--ring);border-radius:14px;padding:14px}
    form label{display:block;margin-top:12px;font-weight:600}
    form input, form textarea, form select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);background:#fff}
    form textarea{min-height:120px}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .cta{background:var(--orange);color:#fff;border:none;padding:10px 14px;border-radius:999px;font-weight:800;cursor:pointer}
    .ghost{background:#fff;color:var(--maroon);border:2px solid var(--maroon)}

    .upi{display:grid;grid-template-columns:1fr auto;gap:14px;align-items:center;margin-top:10px}
    .upi .qr{width:220px;height:220px;border-radius:8px;border:1px solid var(--ring);overflow:hidden;display:flex;align-items:center;justify-content:center;background:#fff}
    .muted{color:var(--muted)}

    footer{background:var(--maroon);color:#fff;margin-top:28px}
    footer .wrap{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;padding:14px 16px}
    code.kbd{background:#fff2e6;border:1px solid var(--orange);padding:2px 6px;border-radius:6px}

    .badge{display:inline-block;background:var(--maroon);color:#fff;padding:6px 12px;border-radius:999px;margin-bottom:10px;font-weight:700}
    .subnav{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 14px}
    .subnav a{background:#fff;border:1px solid var(--ring);padding:6px 10px;border-radius:999px;text-decoration:none}
    .subnav a:hover{border-color:var(--orange)}

    @media (max-width:720px){ .upi{grid-template-columns:1fr} }

    /* Modals */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:80}
    .modal.open{display:flex}
    .panel{width:min(920px,95vw);max-height:90vh;overflow:auto;background:#fff;border-radius:16px;border:2px solid var(--maroon);box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .panel header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--ring)}
    .panel h4{margin:0}
    .panel .content{padding:16px}
    .grid2{display:grid;grid-template-columns:180px 1fr;gap:12px}
    .sizes-editor{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
    .sizes-editor .cell{border:1px solid var(--ring);border-radius:10px;padding:8px}
    .note{font-size:.9rem;color:var(--muted)}
    .danger{color:var(--oos)}

    /* Inline status bar */
    .statusbar{position:sticky;top:48px;z-index:64;background:#fff7ed;border-bottom:1px solid var(--ring);padding:8px 16px;display:flex;gap:10px;align-items:center}
    .pill{border-radius:999px;padding:3px 8px;border:1px solid var(--ring);font-size:.85rem}
    .pill.info{background:#eff6ff;border-color:#bfdbfe}
    .pill.bad{background:#fef2f2;border-color:#fecaca}
    .pill.good{background:#ecfdf5;border-color:#bbf7d0}
  </style>
</head>
<body>
  <header>
    <div class="wrap nav">
      <div class="brand">
        <div class="logo" aria-hidden="true">NE</div>
        <h1>Oxidized Jewellery & Traditional Clothing</h1>
      </div>
      <nav class="menu" aria-label="Main Navigation">
        <a href="#jewellery">Jewellery</a>
        <a href="#traditional">Traditional Clothing</a>
        <a href="#order">Order</a>
        <a href="#contact">Contact</a>
        <a href="#Exchange Policy">Exchange Policy</a>
        <button class="bucket-btn" id="openBucket" title="Open Bucket" aria-haspopup="dialog">
          üß∫ Bucket <span class="count" id="bucketCount">0</span>
        </button>
        <button class="admin-link" id="openAdmin" title="Inventory Manager">Admin</button>
        <button class="admin-link" id="openSync" title="Cloud Inventory Settings">‚öôÔ∏è Sync</button>
      </nav>
    </div>
  </header>

  <div class="statusbar" id="statusbar" hidden>
    <span class="pill info" id="syncState">Sync: Local only</span>
    <span class="muted" id="statusMsg"></span>
  </div>

  <section class="hero">
    <div class="wrap">
      <h2>Shop handcrafted Oxidized Jewellery & Traditional Wear</h2>
      <p>Add items to your <strong>Bucket</strong>, pick <strong>Size</strong> where required, pay via <strong>UPI</strong>, then send your order by <strong>Email</strong> & <strong>WhatsApp</strong>.</p>
    </div>
  </section>

  <!-- Oxidized Jewellery -->
  <section id="jewellery" class="section wrap">
    <span class="badge">Main Category: Jewellery</span>
    <div class="subnav" aria-label="Jewellery subcategories">
      <a href="#Earrings">Earrings</a>
      <a href="#Necklaces">Necklaces</a>
      <a href="#Rings">Rings</a>
      <a href="#Anklets">Anklets</a>
      <a href="#Bangles">Bangles</a>
      <a href="#Bracelets">Bracelets</a>
      <a href="#Mangalsutra">Mangalsutra</a>
    </div>

    <div id="Earrings"><h3>Earrings</h3><div class="grid" data-grid="Earrings"></div></div>
    <div id="Necklaces"><h3>Necklaces</h3><div class="grid" data-grid="Necklaces"></div></div>
    <div id="Rings"><h3>Rings</h3><div class="grid" data-grid="Rings"></div></div>
    <div id="Anklets"><h3>Anklets</h3><div class="grid" data-grid="Anklets"></div></div>
    <div id="Bangles"><h3>Bangles</h3><div class="grid" data-grid="Bangles"></div></div>
    <div id="Bracelets"><h3>Bracelets</h3><div class="grid" data-grid="Bracelets"></div></div>
    <div id="Mangalsutra"><h3>Mangalsutra</h3><div class="grid" data-grid="Mangalsutra"></div></div>
  </section>

  <!-- Traditional Clothing -->
  <section id="traditional" class="section wrap">
    <span class="badge">Main Category: Traditional Clothing</span>
    <div class="subnav" aria-label="Traditional subcategories">
      <a href="#ChaniyaCholi">Chaniya Choli</a>
      <a href="#Kurtis">Kurtis</a>
      <a href="#Kurta">Kurta</a>
    </div>
    <div id="ChaniyaCholi"><h3>Chaniya Choli</h3><div class="grid" data-grid="Chaniya Choli"></div></div>
    <div id="Kurtis"><h3>Kurtis</h3><div class="grid" data-grid="Kurtis"></div></div>
    <div id="Kurta"><h3>Kurta</h3><div class="grid" data-grid="Kurta"></div></div>
  </section>

  <!-- Order & Payment -->
  <section id="order" class="section wrap">
    <h3>Order & Payment</h3>
    <div class="order">
      <p class="muted">Fill your details, review your bucket, then <strong>submit by Email</strong> and/or <strong>send via WhatsApp</strong>. Pay securely using the UPI options below.</p>

      <div class="row"><span>Grand Total:</span> <span class="total" id="grandTotal">‚Çπ0</span></div>

      <div class="upi" aria-label="UPI payment options">
        <div>
          <label>UPI ID</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="upiId" value="7990639743@ybl" readonly />
            <button class="btn" id="copyUpi">Copy</button>
          </div>
          <div class="actions">
            <a id="upiDeepLink" class="cta" href="#" target="_blank" rel="nofollow noopener">Pay via UPI App</a>
            <button class="btn ghost" id="refreshQR" type="button">Refresh QR for Current Total</button>
          </div>
          <p class="muted" style="margin:6px 0 0"> Deep link & QR use the amount in your bucket (updates live).</p>
        </div>
        <div class="qr" id="qrBox" aria-label="UPI QR Code">
          <span class="muted" id="qrHint">QR</span>
        </div>
      </div>

      <form id="orderForm" action="https://formsubmit.co/salesnityaenterprises@gmail.com" method="POST" novalidate>
        <input type="hidden" name="_subject" value="New Order ‚Äî Nitya Enterprises"/>
        <input type="hidden" name="_captcha" value="false"/>
        <input type="hidden" name="_template" value="table"/>
        <input type="hidden" name="order_details" id="order_details"/>
        <input type="hidden" name="order_total" id="order_total"/>

        <label for="custName">Customer Name</label>
        <input id="custName" name="customer_name" placeholder="Your full name" required />

        <label for="mobile">Customer Mobile No (10 digits)</label>
        <input id="mobile" name="customer_mobile" inputmode="numeric" pattern="[0-9]{10}" placeholder="e.g., 9510683160" required />

        <label for="altContact">Contact No (Alternate)</label>
        <input id="altContact" name="alternate_contact" inputmode="numeric" pattern="[0-9]{10}" placeholder="Optional" />

        <label for="addr">Address (Building No, Landmark, Area, City, State, Pincode)</label>
        <textarea id="addr" name="address" placeholder="Building No, Landmark, Area, City, State, Pincode" required></textarea>

        <label for="notes">Any Notes (Size/Color preferences, etc.)</label>
        <textarea id="notes" name="notes" placeholder="Optional"></textarea>

        <label for="summary">Order Summary (auto-filled)</label>
        <textarea id="summary" readonly></textarea>

        <div class="actions">
          <button type="submit" class="cta">Submit Order by Email</button>
          <button type="button" class="btn" id="sendWhatsApp">Send Order via WhatsApp</button>
          <button type="button" class="btn ghost" id="clearBucket">Clear Bucket</button>
        </div>
        <p class="muted">Orders go to <strong>salesnityaenterprises@gmail.com</strong> and can also be sent to WhatsApp <strong>+91 9510683160</strong>.</p>
      </form>
    </div>
  </section>

  <!-- Contact -->
  <section id="contact" class="section wrap">
    <h3>Contact Us</h3>
    <p>Email: <a href="mailto:salesnityaenterprises@gmail.com">salesnityaenterprises@gmail.com</a> &nbsp; | &nbsp; Mobile: <a href="tel:+919510683160">+91 9510683160</a></p>
  </section>

  <!-- Exchange Policy -->
  <section id="Exchange Policy" class="section wrap">
    <h3>Exchange Policy</h3>
    <ul>
      <li><strong>How to request:</strong> Share your order details along with a <strong>clear video recorded while unpacking the product</strong> via the <a href="#contact">Contact Us</a> details, or WhatsApp us at <strong>+91 95106 83160</strong>.</li>
      <li>Mention the reason for exchange (size issue, wrong item, damaged item, etc.).</li>
    </ul>
  </section>

  <footer>
    <div class="wrap">
      <div>¬© <span id="yr"></span> Nitya Enterprises ‚Ä¢ Ahmedabad ‚Ä¢ All India shipping</div>
    </div>
  </footer>

  <!-- Bucket Drawer -->
  <div class="drawer" id="drawer" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
    <header class="wrap" style="padding:12px 16px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <h4 id="drawerTitle">Your Bucket</h4>
        <button class="btn" id="closeBucket">Close ‚úï</button>
      </div>
    </header>
    <div class="body" id="cartList"></div>
    <div class="pad" style="border-top:1px solid var(--ring)">
      <div class="row"><span>Items:</span><span id="bucketItems">0</span></div>
      <div class="row total"><span>Total:</span><span id="bucketTotal">‚Çπ0</span></div>
      <div class="actions">
        <a class="btn bucket" href="#order" id="goOrder">Proceed to Order</a>
        <button class="btn" id="emptyCart">Empty</button>
      </div>
    </div>
  </div>

  <!-- Inventory Admin Modal -->
  <div class="modal" id="adminModal" aria-hidden="true" aria-label="Inventory Manager">
    <div class="panel">
      <header>
        <h4>Inventory Manager (Per Size)</h4>
        <div style="display:flex;gap:8px">
          <button class="btn ghost" id="exportJson">Export JSON</button>
          <button class="btn" id="importJson">Import JSON</button>
          <button class="btn" id="pullCloud">Pull from Cloud</button>
          <button class="btn" id="pushCloud">Push to Cloud</button>
          <button class="btn" id="resetInv">Clear All Stock</button>
          <button class="btn" id="closeAdmin">Close ‚úï</button>
        </div>
      </header>
      <div class="content">
        <p class="note">Tip: Leave a field <em>blank</em> for unlimited stock. Set <strong>0</strong> to mark a size as <span class="danger">Out of Stock</span>. Values persist in this browser and can be synced to the cloud when configured.</p>
        <div class="grid2" style="margin-top:12px">
          <div>
            <label for="productPick"><strong>Select Product</strong></label>
            <select id="productPick"></select>
          </div>
          <div>
            <div class="sizes-editor" id="sizesEditor"></div>
          </div>
        </div>
        <div class="actions" style="margin-top:14px">
          <button class="cta" id="saveInv">Save Changes</button>
          <span class="note">Passcode used in this session.</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Sync Settings Modal -->
  <div class="modal" id="syncModal" aria-hidden="true" aria-label="Inventory Sync Settings">
    <div class="panel">
      <header>
        <h4>Cloud Inventory Settings</h4>
        <div style="display:flex;gap:8px">
          <button class="btn" id="testSync">Test Connection</button>
          <button class="btn" id="closeSync">Close ‚úï</button>
        </div>
      </header>
      <div class="content">
        <p class="note">Use <strong>JSONBin</strong> (recommended) or your own HTTPS endpoint. For JSONBin v3, create a Bin and paste the details below. <a href="https://jsonbin.io/" target="_blank" rel="noopener">jsonbin.io</a></p>
        <div class="grid2" style="grid-template-columns:1fr 2fr">
          <div>
            <label>Provider</label>
            <select id="syncProvider">
              <option value="jsonbin">JSONBin (v3)</option>
              <option value="custom">Custom Endpoint</option>
            </select>
          </div>
          <div></div>

          <div><label>JSONBin Bin ID</label></div>
          <div><input id="jsonbinId" placeholder="e.g. 66d0abcd1234ef5678901234"/></div>

          <div><label>JSONBin API Key</label></div>
          <div><input id="jsonbinKey" placeholder="x-master-key"/></div>

          <div><label>Custom GET URL</label></div>
          <div><input id="customGet" placeholder="https://yourdomain.example/inventory.json"/></div>

          <div><label>Custom PUT/POST URL</label></div>
          <div><input id="customPut" placeholder="https://yourdomain.example/inventory"/></div>
        </div>
        <div class="actions" style="margin-top:14px">
          <button class="cta" id="saveSync">Save Settings</button>
          <span class="note">Settings are stored locally in this browser.</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ==============================
       CONFIG
       ============================== */
    const SELLER_WHATSAPP = "+919510683160";
    const UPI_ID = "7990639743@ybl";
    const PAYEE_NAME = "Nitya Enterprises";
    const FREE_SIZE_LABEL = "Free Size";

    const CART_KEY = 'nitya_cart_v4_sizes';
    const INV_KEY  = 'nitya_inventory_v1';           // { [pid]: { [sizeKey]: number|null }, ... }
    const ADMIN_PASS = 'nitya@123';

    // Cloud sync config (saved locally, affects cross‚Äëdevice via remote store)
    const SYNC_KEY = 'nitya_inventory_sync_v1';      // { provider:'jsonbin'|'custom', jsonbinId, jsonbinKey, customGet, customPut }

    /* ===== Catalog (trimmed to keep file size reasonable; add rest as needed) ===== */
    const catalog = [
      {id:"ear-01", name:"German Silver Premium Quality Earings -a", price:400, cat:"Earrings", img:"assets/earrings images/E-1.jpeg"},
      {id:"ring-01", name:"German Silver Premium Quality Free Size ring-a", price:390, cat:"Rings", img:"assets/Ring 2_1_11zon.jpeg", sizes:["Free Size","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20"]},
      {id:"ban-01", name:"Oxides Fancy Bacchu Kada -a (pair)", price:450, cat:"Bangles", img:"assets/images/bangles/B-1.jpeg"},
      {id:"cc-01", name:"Navratri Chaniya choli-a", price:2649, cat:"Chaniya Choli", img:"assets/chaniya choli images/CC-1.jpeg"}
      // (‚Ä¶ include full catalog from your previous file ‚Ä¶)
    ];

    // Default sizes if product has none
    const DEFAULT_SIZES = {
      "Chaniya Choli": ["Free Size","S","M","L","XL","XXL"],
      "Kurtis": ["Free Size","S","M","L","XL","XXL"],
      "Kurta": ["Free Size","S","M","L","XL","XXL"],
      "Bangles": ["Free Size","2.2","2.4","2.6","2.8","2.10","2.12"]
    };

    // Selected size per product
    const selectedSize = new Map();

    /* ==============================
       SYNC HELPERS (Cloud)
       ============================== */
    const statusbar   = document.getElementById('statusbar');
    const syncStateEl = document.getElementById('syncState');
    const statusMsgEl = document.getElementById('statusMsg');

    function getSync(){
      try{ return JSON.parse(localStorage.getItem(SYNC_KEY)||'{}'); }catch{ return {}; }
    }
    function setSync(v){ localStorage.setItem(SYNC_KEY, JSON.stringify(v||{})); updateSyncBadge(); }

    function updateSyncBadge(){
      statusbar.hidden = false;
      const s = getSync();
      if(s.provider === 'jsonbin' && s.jsonbinId && s.jsonbinKey){
        syncStateEl.textContent = 'Sync: JSONBin';
        syncStateEl.className = 'pill good';
      }else if(s.provider === 'custom' && s.customGet && s.customPut){
        syncStateEl.textContent = 'Sync: Custom';
        syncStateEl.className = 'pill good';
      }else{
        syncStateEl.textContent = 'Sync: Local only';
        syncStateEl.className = 'pill info';
      }
    }
    function setStatus(msg, type='info'){ statusMsgEl.textContent = msg||''; }

    async function fetchRemoteInv(){
      const s = getSync();
      if(s.provider === 'jsonbin' && s.jsonbinId && s.jsonbinKey){
        const url = `https://api.jsonbin.io/v3/b/${encodeURIComponent(s.jsonbinId)}`;
        const res = await fetch(url, { headers: { 'X-Master-Key': s.jsonbinKey, 'X-Bin-Meta': 'false' } });
        if(!res.ok) throw new Error('JSONBin GET failed: '+res.status);
        return await res.json();
      } else if(s.provider === 'custom' && s.customGet){
        const res = await fetch(s.customGet, { cache:'no-store' });
        if(!res.ok) throw new Error('Custom GET failed: '+res.status);
        return await res.json();
      } else {
        throw new Error('Remote sync not configured');
      }
    }

    async function pushRemoteInv(obj){
      const s = getSync();
      const body = JSON.stringify(obj||{});
      if(s.provider === 'jsonbin' && s.jsonbinId && s.jsonbinKey){
        const url = `https://api.jsonbin.io/v3/b/${encodeURIComponent(s.jsonbinId)}`;
        const res = await fetch(url, { method:'PUT', headers:{ 'Content-Type':'application/json', 'X-Master-Key': s.jsonbinKey }, body });
        if(!res.ok) throw new Error('JSONBin PUT failed: '+res.status);
        return true;
      } else if(s.provider === 'custom' && s.customPut){
        const res = await fetch(s.customPut, { method:'PUT', headers:{ 'Content-Type':'application/json' }, body });
        if(!res.ok){
          // try POST as fallback
          const res2 = await fetch(s.customPut, { method:'POST', headers:{ 'Content-Type':'application/json' }, body });
          if(!res2.ok) throw new Error('Custom PUT/POST failed: '+res.status+'/'+res2.status);
        }
        return true;
      } else {
        throw new Error('Remote sync not configured');
      }
    }

    /* ==============================
       INVENTORY HELPERS (Local + Cloud merge)
       ============================== */
    function loadInvLocal(){ try{ return JSON.parse(localStorage.getItem(INV_KEY) || '{}'); } catch{ return {}; } }
    function saveInvLocal(inv){ localStorage.setItem(INV_KEY, JSON.stringify(inv||{})); }

    async function loadInv(){
      // Try remote first; if not configured or fails, fall back to local
      try{
        const remote = await fetchRemoteInv();
        if(remote && typeof remote === 'object'){
          saveInvLocal(remote);
          setStatus('Loaded inventory from cloud.', 'good');
          return remote;
        }
      }catch(err){ setStatus((err.message||'') + ' ‚Äî using local inventory.'); }
      return loadInvLocal();
    }

    async function saveInv(inv, {push=true}={}){
      saveInvLocal(inv);
      if(push){
        try{ await pushRemoteInv(inv); setStatus('Inventory saved to cloud.', 'good'); }
        catch(err){ setStatus('Saved locally. Cloud save failed: '+err.message, 'bad'); }
      }
    }

    function sizeKeysFor(p){
      const sizes = (Array.isArray(p.sizes) && p.sizes.length) ? p.sizes : (DEFAULT_SIZES[p.cat] || []);
      return sizes.length ? sizes : ['_']; // '_' means one-size/no-size
    }
    function productHasSizes(p){
      const sizes = (Array.isArray(p.sizes) && p.sizes.length) ? p.sizes : (DEFAULT_SIZES[p.cat] || []);
      return sizes.length > 0;
    }

    async function getStock(pid, sizeKey){
      const inv = await currentInv();
      const v = inv?.[pid]?.[sizeKey ?? '_'];
      if (v === undefined || v === null || v === '') return Infinity; // blank/undefined => unlimited
      const n = Number(v);
      return Number.isFinite(n) ? n : Infinity;
    }

    function setStockLocal(inv, pid, sizeKey, qty){
      inv[pid] = inv[pid] || {};
      inv[pid][sizeKey] = (qty === '' || qty === null) ? null : Number(qty);
    }

    // cached in‚Äëmemory to avoid re‚Äëfetch on every getStock
    let INV_CACHE = null;
    async function currentInv(){ if(!INV_CACHE) INV_CACHE = await loadInv(); return INV_CACHE; }
    function invalidateInv(){ INV_CACHE = null; }

    /* ==============================
       RENDER CATALOG
       ============================== */
    async function renderCatalog(){
      // Ensure inventory is loaded before rendering to correctly disable size chips
      await currentInv();
      document.querySelectorAll('[data-grid]').forEach(g => g.innerHTML = "");
      for(const p of catalog){
        const grid = document.querySelector(`[data-grid="${p.cat}"]`);
        if(!grid) continue;

        const card = document.createElement('div');
        card.className = 'card';

        let sizeBlock = '';
        const availSizes = sizeKeysFor(p);
        if (availSizes.length) {
          const opts = await Promise.all(availSizes.map(async sz => {
            const stock = await getStock(p.id, sz);
            const disabled = stock === 0;
            return `<button class="size-btn" data-size="${sz}" data-for="${p.id}" ${disabled?'disabled aria-disabled="true"':''} aria-pressed="${selectedSize.get(p.id)===sz}">
              ${sz}<span class="stock-dot" aria-hidden="true"></span>
            </button>`;
          }));
          const hint = (p.cat === "Bangles") ? "" : `<div class="size-hint"><strong>Currently Available Size:</strong> ${FREE_SIZE_LABEL}</div>`;
          sizeBlock = `
            <div class="sizes" role="group" aria-label="Select size">
              ${opts.join('')}
            </div>
            ${hint}`;
        }

        card.innerHTML = `
          <img class="thumb" src="${p.img}" alt="${p.name}"/>
          <div class="pad">
            <div class="title">${p.name}</div>
            <div class="price">‚Çπ${p.price.toLocaleString()}</div>
            ${sizeBlock}
            <div class="btns">
              <button class="btn add" data-add="${p.id}">Add to Bucket</button>
              <button class="btn remove" data-remove="${p.id}">Remove</button>
            </div>
          </div>`;
        grid.appendChild(card);
      }
    }

    /* ==============================
       CART (per size)
       ============================== */
    const cart = JSON.parse(localStorage.getItem(CART_KEY) || '{}');
    function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
    function parseCartId(cid){ const [pid, size] = cid.split('__'); return {pid, size}; }
    function cartItems(){
      return Object.entries(cart).map(([cid,q])=>{
        const {pid, size} = parseCartId(cid);
        const base = catalog.find(p=>p.id===pid);
        if(!base) return null;
        return { ...base, cid, size, qty:q };
      }).filter(Boolean);
    }
    function cartQtyFor(pid, size){
      const cid = size ? `${pid}__${size}` : pid;
      return cart[cid] || 0;
    }
    function cartTotal(){ return cartItems().reduce((s,i)=> s + i.price*i.qty, 0); }

    async function addItem(cid, qty=1){
      const {pid, size} = parseCartId(cid);
      const max = await getStock(pid, size || '_');
      const now = cart[cid] || 0;
      if (now + qty > max){
        alert(max === Infinity ? 'Unlimited stock ‚Äî unexpected cap' : `Only ${max} left for this size.`);
        if (max > now){ cart[cid] = max; }
        saveCart(); refresh(); return;
      }
      cart[cid] = now + qty;
      if(cart[cid] <= 0) delete cart[cid];
      saveCart(); refresh();
    }
    function removeItem(cid, qty=1){
      if(!cart[cid]) return;
      cart[cid] -= qty;
      if(cart[cid] <= 0) delete cart[cid];
      saveCart(); refresh();
    }
    function clearCart(){ for(const k in cart) delete cart[k]; saveCart(); refresh(); }

    /* ==============================
       UI REFRESH
       ============================== */
    const bucketCount = document.getElementById('bucketCount');
    const bucketTotal = document.getElementById('bucketTotal');
    const bucketItemsEl = document.getElementById('bucketItems');
    const cartList = document.getElementById('cartList');
    const grandTotal = document.getElementById('grandTotal');
    const orderSummary = document.getElementById('summary');
    const hiddenDetails = document.getElementById('order_details');
    const hiddenTotal = document.getElementById('order_total');

    async function refresh(){
      // refresh catalog buttons stock
      const inv = await currentInv();
      document.querySelectorAll('.size-btn').forEach(btn=>{
        const pid = btn.getAttribute('data-for');
        const sz  = btn.getAttribute('data-size');
        const v = inv?.[pid]?.[sz];
        const stock = (v===undefined||v===null||v==='')?Infinity:Number(v);
        if (stock === 0){
          btn.setAttribute('disabled','true');
          btn.setAttribute('aria-disabled','true');
        } else {
          btn.removeAttribute('disabled');
          btn.removeAttribute('aria-disabled');
        }
      });

      const items = cartItems();
      const total = cartTotal();
      bucketCount.textContent = items.reduce((s,i)=>s+i.qty,0);
      document.getElementById('bucketItems')?.textContent = bucketCount.textContent;
      bucketTotal.textContent = `‚Çπ${total.toLocaleString()}`;
      grandTotal.textContent = `‚Çπ${total.toLocaleString()}`;

      cartList.innerHTML = items.length ? '' : '<p class="muted">Your bucket is empty. Add some products!</p>';
      items.forEach(it => {
        const row = document.createElement('div');
        row.className = 'cart-item';
        const sizeText = it.size ? ` <span class="small">(Size ${it.size})</span>` : '';
        const leftVal = (inv?.[it.id]?.[it.size||'_']);
        const left = (leftVal===undefined||leftVal===null||leftVal==='')?Infinity:Number(leftVal);
        const remaining = (left===Infinity) ? '‚àû' : (left - it.qty);
        row.innerHTML = `
          <img src="${it.img}" alt="${it.name}">
          <div>
            <div class="title">${it.name}${sizeText}</div>
            <div class="small">Qty: ${it.qty} √ó ‚Çπ${it.price.toLocaleString()} ‚Ä¢ Left: ${remaining < 0 ? 0 : remaining}</div>
          </div>
          <div>
            <button class="btn" onclick="addItem('${it.cid}',1)">+1</button>
            <button class="btn" onclick="removeItem('${it.cid}',1)">‚àí1</button>
          </div>`;
        cartList.appendChild(row);
      });

      const lines = items.map(it => `‚Ä¢ ${it.name}${it.size ? ' (Size ' + it.size + ')' : ''} ‚Äî Qty ${it.qty} ‚Äî ‚Çπ${(it.qty*it.price).toLocaleString()}`);
      const summaryText = (lines.join('\n') || 'No items in bucket') + `\n\nTotal: ‚Çπ${total.toLocaleString()}`;
      orderSummary.value = summaryText;
      hiddenDetails.value = summaryText;
      hiddenTotal.value = total;

      updateUpi(total);
    }

    /* ==============================
       EVENTS: Size/Cart
       ============================== */
    document.addEventListener('click', async (e)=>{
      const sizeBtn = e.target.closest('.size-btn');
      if(sizeBtn){
        if(sizeBtn.hasAttribute('disabled')) return;
        const pid = sizeBtn.getAttribute('data-for');
        const sz = sizeBtn.getAttribute('data-size');
        selectedSize.set(pid, sz);
        const card = sizeBtn.closest('.card');
        card.querySelectorAll(`.size-btn[data-for="${pid}"]`).forEach(b=>b.setAttribute('aria-pressed','false'));
        sizeBtn.setAttribute('aria-pressed','true');
      }

      const add = e.target.closest('[data-add]');
      const rem = e.target.closest('[data-remove]');

      if(add){
        const pid = add.dataset.add;
        const product = catalog.find(p=>p.id===pid);
        const needSizes = productHasSizes(product);
        if(needSizes){
          const sel = selectedSize.get(pid);
          if(!sel){ alert('Please select a size before adding to the bucket.'); return; }
          const left = await getStock(pid, sel);
          const inCart = cartQtyFor(pid, sel);
          if (inCart + 1 > left){ alert(left===Infinity?'':'Only '+left+' left for this size.'); return; }
          addItem(`${pid}__${sel}`,1);
        }else{
          const left = await getStock(pid, '_');
          const inCart = cartQtyFor(pid, null);
          if (inCart + 1 > left){ alert(left===Infinity?'':'Only '+left+' left.'); return; }
          addItem(pid,1);
        }
      }
      if(rem){
        const pid = rem.dataset.remove;
        const product = catalog.find(p=>p.id===pid);
        const needSizes = productHasSizes(product);
        if(needSizes){
          const sel = selectedSize.get(pid);
          if(!sel){ alert('Select a size to remove.'); return; }
          removeItem(`${pid}__${sel}`,1);
        }else{
          removeItem(pid,1);
        }
      }
    });

    /* ==============================
       DRAWER + ORDER + UPI
       ============================== */
    const drawer = document.getElementById('drawer');
    document.getElementById('openBucket').addEventListener('click', ()=>drawer.classList.add('open'));
    document.getElementById('closeBucket').addEventListener('click', ()=>drawer.classList.remove('open'));
    document.getElementById('emptyCart').addEventListener('click', ()=>{ if(confirm('Clear all items from bucket?')) clearCart(); });
    document.getElementById('goOrder').addEventListener('click', ()=>drawer.classList.remove('open'));
    document.getElementById('clearBucket').addEventListener('click', ()=>{ if(confirm('Clear all items from bucket?')) clearCart(); });

    const upiDeepLink = document.getElementById('upiDeepLink');
    const qrBox = document.getElementById('qrBox');
    const copyUpiBtn = document.getElementById('copyUpi');
    const refreshQR = document.getElementById('refreshQR');

    function upiUrl(amount){
      const params = new URLSearchParams({ pa: UPI_ID, pn: PAYEE_NAME, am: String(amount||''), cu: 'INR' });
      return `upi://pay?${params.toString()}`;
    }
    function updateUpi(amount){
      upiDeepLink.href = upiUrl(amount);
      const data = encodeURIComponent(upiUrl(amount));
      const src = `https://api.qrserver.com/v1/create-qr-code/?size=512x512&data=${data}`;
      qrBox.innerHTML = `<img alt="UPI QR Code" width="220" height="220" style="width:100%;height:100%;object-fit:contain" src="${src}">`;
    }
    copyUpiBtn.addEventListener('click', ()=>{
      navigator.clipboard.writeText(UPI_ID).then(()=>{
        copyUpiBtn.textContent='Copied!';
        setTimeout(()=>copyUpiBtn.textContent='Copy',1200);
      });
    });
    refreshQR.addEventListener('click', ()=> updateUpi(cartTotal()));

    const sendWhatsApp = document.getElementById('sendWhatsApp');
    sendWhatsApp.addEventListener('click', ()=>{
      const name = document.getElementById('custName').value || '(No name)';
      const mobile = document.getElementById('mobile').value || '(No mobile)';
      const alt = document.getElementById('altContact').value || '-';
      const address = document.getElementById('addr').value || '(No address)';
      const notes = document.getElementById('notes').value || '-';
      const text = `*New Order ‚Äî Nitya Enterprises*\n\n`+
        `*Customer:* ${name}\n*Mobile:* ${mobile}\n*Alt:* ${alt}\n*Address:* ${address}\n*Notes:* ${notes}\n\n`+
        `${orderSummary.value}`;
      const url = `https://wa.me/${SELLER_WHATSAPP}?text=${encodeURIComponent(text)}`;
      window.open(url,'_blank','noopener');
    });

    document.getElementById('orderForm').addEventListener('submit', (e)=>{
      if(cartTotal() <= 0){ e.preventDefault(); alert('Your bucket is empty. Please add items before submitting.'); return; }
      if(!document.getElementById('mobile').checkValidity()){ e.preventDefault(); alert('Please enter a valid 10-digit mobile number.'); return; }
    });

    /* ==============================
       ADMIN INVENTORY MODAL
       ============================== */
    const adminBtn = document.getElementById('openAdmin');
    const adminModal = document.getElementById('adminModal');
    const closeAdminBtn = document.getElementById('closeAdmin');
    const productPick = document.getElementById('productPick');
    const sizesEditor = document.getElementById('sizesEditor');
    const saveInvBtn = document.getElementById('saveInv');
    const exportBtn = document.getElementById('exportJson');
    const importBtn = document.getElementById('importJson');
    const resetInvBtn = document.getElementById('resetInv');
    const pullCloudBtn = document.getElementById('pullCloud');
    const pushCloudBtn = document.getElementById('pushCloud');

    function openAdmin(){
      const code = prompt('Enter admin passcode to edit inventory:');
      if(code !== ADMIN_PASS){ alert('Wrong passcode.'); return; }
      productPick.innerHTML = catalog.map(p=>`<option value="${p.id}">${p.name} ‚Äî [${p.cat}]</option>`).join('');
      renderSizeInputs(productPick.value);
      adminModal.classList.add('open');
      adminModal.setAttribute('aria-hidden','false');
    }
    function closeAdmin(){
      adminModal.classList.remove('open');
      adminModal.setAttribute('aria-hidden','true');
    }
    adminBtn.addEventListener('click', openAdmin);
    closeAdminBtn.addEventListener('click', closeAdmin);
    adminModal.addEventListener('click', (e)=>{ if(e.target === adminModal) closeAdmin(); });

    productPick.addEventListener('change', ()=> renderSizeInputs(productPick.value));

    async function renderSizeInputs(pid){
      const inv = await currentInv();
      sizesEditor.innerHTML = '';
      const p = catalog.find(x=>x.id===pid);
      const keys = sizeKeysFor(p);
      const obj = inv[pid] || {};
      keys.forEach(k=>{
        const val = (obj[k] ?? '');
        const label = (k === '_') ? 'No size' : k;
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.innerHTML = `
          <div style="font-weight:700;margin-bottom:6px">${label}</div>
          <input type="number" min="0" step="1" inputmode="numeric" data-sizekey="${k}" placeholder="blank = unlimited" value="${val === null ? '' : val}">
        `;
        sizesEditor.appendChild(cell);
      });
    }

    saveInvBtn.addEventListener('click', async ()=>{
      const pid = productPick.value;
      const inv = await currentInv();
      const inputs = sizesEditor.querySelectorAll('input[data-sizekey]');
      inputs.forEach(inp=>{
        const k = inp.getAttribute('data-sizekey');
        const v = inp.value;
        setStockLocal(inv, pid, k, v === '' ? null : Math.max(0, parseInt(v,10) || 0));
      });
      await saveInv(inv, {push:true});
      alert('Inventory saved for '+pid);
      invalidateInv();
      await renderCatalog();
      await refresh();
      await renderSizeInputs(productPick.value);
    });

    exportBtn.addEventListener('click', async ()=>{
      const inv = await currentInv();
      const blob = new Blob([JSON.stringify(inv,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'nitya-inventory.json';
      document.body.appendChild(a); a.click(); a.remove();
    });

    importBtn.addEventListener('click', ()=>{
      const inp = document.createElement('input');
      inp.type='file'; inp.accept='.json,application/json';
      inp.onchange = async ()=>{
        const f = inp.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = async ()=>{
          try{
            const obj = JSON.parse(reader.result);
            if(typeof obj !== 'object') throw new Error('Invalid JSON');
            await saveInv(obj, {push:true});
            alert('Inventory imported and pushed to cloud.');
            invalidateInv(); await renderCatalog(); await refresh(); await renderSizeInputs(productPick.value);
          }catch(err){ alert('Import failed: '+err.message); }
        };
        reader.readAsText(f);
      };
      inp.click();
    });

    resetInvBtn.addEventListener('click', async ()=>{
      if(confirm('Clear ALL saved stock values? This will make everything unlimited.')){
        const obj = {};
        await saveInv(obj, {push:true});
        alert('Inventory cleared.');
        invalidateInv(); await renderCatalog(); await refresh(); await renderSizeInputs(productPick.value);
      }
    });

    pullCloudBtn.addEventListener('click', async ()=>{
      try{ const remote = await fetchRemoteInv(); saveInvLocal(remote); invalidateInv(); await renderCatalog(); await refresh(); await renderSizeInputs(productPick.value); alert('Pulled latest inventory from cloud.'); }
      catch(err){ alert('Pull failed: '+err.message); }
    });

    pushCloudBtn.addEventListener('click', async ()=>{
      try{ const inv = await currentInv(); await pushRemoteInv(inv); alert('Pushed local inventory to cloud.'); }
      catch(err){ alert('Push failed: '+err.message); }
    });

    /* ==============================
       SYNC SETTINGS MODAL
       ============================== */
    const openSyncBtn = document.getElementById('openSync');
    const syncModal = document.getElementById('syncModal');
    const closeSyncBtn = document.getElementById('closeSync');
    const saveSyncBtn = document.getElementById('saveSync');
    const testSyncBtn = document.getElementById('testSync');

    const syncProvider = document.getElementById('syncProvider');
    const jsonbinId = document.getElementById('jsonbinId');
    const jsonbinKey = document.getElementById('jsonbinKey');
    const customGet = document.getElementById('customGet');
    const customPut = document.getElementById('customPut');

    function openSync(){
      const s = getSync();
      syncProvider.value = s.provider || 'jsonbin';
      jsonbinId.value = s.jsonbinId || '';
      jsonbinKey.value = s.jsonbinKey || '';
      customGet.value = s.customGet || '';
      customPut.value = s.customPut || '';
      syncModal.classList.add('open');
      syncModal.setAttribute('aria-hidden','false');
    }
    function closeSync(){ syncModal.classList.remove('open'); syncModal.setAttribute('aria-hidden','true'); }

    openSyncBtn.addEventListener('click', openSync);
    closeSyncBtn.addEventListener('click', closeSync);
    syncModal.addEventListener('click', (e)=>{ if(e.target === syncModal) closeSync(); });

    saveSyncBtn.addEventListener('click', ()=>{
      const v = {
        provider: syncProvider.value,
        jsonbinId: jsonbinId.value.trim(),
        jsonbinKey: jsonbinKey.value.trim(),
        customGet: customGet.value.trim(),
        customPut: customPut.value.trim()
      };
      setSync(v);
      alert('Sync settings saved.');
    });

    testSyncBtn.addEventListener('click', async ()=>{
      try{ await fetchRemoteInv(); alert('Connection OK ‚Äî able to read inventory.'); }
      catch(err){ alert('Test failed: '+err.message); }
    });

    /* ==============================
       INIT
       ============================== */
    document.getElementById('yr').textContent = new Date().getFullYear();
    updateSyncBadge();

    // initial load/paint
    (async ()=>{ await renderCatalog(); await refresh(); })();
  </script>
</body>
</html>
